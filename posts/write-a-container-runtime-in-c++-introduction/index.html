<!doctype html><html lang=cn><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><title class=pjax-title>开篇 - Nitro's Blog</title><meta name=Description content="Nitro's Blog"><meta property="og:title" content="开篇"><meta property="og:description" content="本篇文章将开启一个新的系列：自己动手用 C++ 实现一个容器运行时。"><meta property="og:type" content="article"><meta property="og:url" content="https://nitroc.org/posts/write-a-container-runtime-in-c++-introduction/"><meta property="og:image" content="https://nitroc.org/logo.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-05-08T11:12:05+08:00"><meta property="article:modified_time" content="2022-05-08T11:12:05+08:00"><meta property="og:site_name" content="Nitro's Blog"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://nitroc.org/logo.png"><meta name=twitter:title content="开篇"><meta name=twitter:description content="本篇文章将开启一个新的系列：自己动手用 C++ 实现一个容器运行时。"><meta name=application-name content="Nitro's Blog"><meta name=apple-mobile-web-app-title content="Nitro's Blog"><meta name=theme-color content="#f8f8f8"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=canonical href=https://nitroc.org/posts/write-a-container-runtime-in-c++-introduction/><link rel=prev href=https://nitroc.org/posts/cli11-tutorial/><link rel=stylesheet href=/lib/normalize/normalize.min.css><link rel=stylesheet href=/css/style.min.css><link rel=preload as=style onload='this.onload=null,this.rel="stylesheet"' href=/lib/fontawesome-free/all.min.css><noscript><link rel=stylesheet href=/lib/fontawesome-free/all.min.css></noscript><link rel=preload as=style onload='this.onload=null,this.rel="stylesheet"' href=/lib/animate/animate.min.css><noscript><link rel=stylesheet href=/lib/animate/animate.min.css></noscript><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"开篇","inLanguage":"cn","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/nitroc.org\/posts\/write-a-container-runtime-in-c\u002b\u002b-introduction\/"},"genre":"posts","keywords":"Linux, Container, Cloud Native","wordcount":138,"url":"https:\/\/nitroc.org\/posts\/write-a-container-runtime-in-c\u002b\u002b-introduction\/","datePublished":"2022-05-08T11:12:05+08:00","dateModified":"2022-05-08T11:12:05+08:00","publisher":{"@type":"Organization","name":"Nitro Cao"},"author":{"@type":"Person","name":"Nitro Cao"},"description":""}</script></head><body header-desktop=auto header-mobile=auto><script type=text/javascript>function setTheme(e){document.body.setAttribute("theme",e),document.documentElement.style.setProperty("color-scheme",e==="light"?"light":"dark")}function saveTheme(e){window.localStorage&&localStorage.setItem("theme",e)}function getMeta(t){const e=document.getElementsByTagName("meta");for(let n=0;n<e.length;n++)if(e[n].getAttribute("name")===t)return e[n];return''}if(window.localStorage&&localStorage.getItem("theme")){let e=localStorage.getItem("theme");e==="light"||e==="dark"||e==="black"?setTheme(e):window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?setTheme("dark"):setTheme("light")}else''==="light"||''==="dark"||''==="black"?(setTheme(''),saveTheme('')):(saveTheme("auto"),window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?setTheme("dark"):setTheme("light"));let metaColors={light:"#f8f8f8",dark:"#252627",black:"#000000"};getMeta("theme-color").content=metaColors[document.body.getAttribute("theme")]</script><div id=back-to-top></div><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title="Nitro's Blog"><img class="lazyload logo" data-src=/logo.png data-srcset="/logo.png, /logo.png 1.5x, /logo.png 2x" data-sizes=auto alt=/logo.png title=/logo.png>Nitro's Blog</a></div><div class=menu><div class=menu-inner><a class=menu-item href=/posts/>Posts </a><a class=menu-item href=/tags/>Tags </a><a class=menu-item href=/categories/>Categories </a><a class=menu-item href=/series/>Series </a><span class="menu-item delimiter"></span><a href=# onclick=return!1 class="menu-item theme-switch" title>
<i class="fas fa-adjust fa-fw"></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title="Nitro's Blog"><img class="lazyload logo" data-src=/logo.png data-srcset="/logo.png, /logo.png 1.5x, /logo.png 2x" data-sizes=auto alt=/logo.png title=/logo.png>Nitro's Blog</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><a class=menu-item href=/posts/ title>Posts</a><a class=menu-item href=/tags/ title>Tags</a><a class=menu-item href=/categories/ title>Categories</a><a class=menu-item href=/series/ title>Series</a><a href=# onclick=return!1 class="menu-item theme-switch" title>
<i class="fas fa-adjust fa-fw"></i></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title></h2><div class=toc-content id=toc-content-auto><nav id=TableOfContents><ul><li><a href=#简介>简介</a></li><li><a href=#为什么是-c>为什么是 C++</a></li><li><a href=#完成本系列能够收获什么>完成本系列能够收获什么</a></li><li><a href=#预备知识>预备知识</a></li><li><a href=#我的开发环境>我的开发环境</a></li><li><a href=#搭建项目架构>搭建项目架构</a></li></ul></nav></div></div><script>document.getElementsByTagName("main")[0].setAttribute("pageStyle","normal")</script><script>document.getElementsByTagName("main")[0].setAttribute("autoTOC","true")</script><article class="page single"><h1 class="single-title animate__animated animate__flipInX">开篇</h1><div class=post-meta><div class=post-meta-line><span class=post-author><i class="author fas fa-user-circle fa-fw"></i><a href=/ title=Author rel=author class=author>Nitro Cao</a>
</span>&nbsp;<span class=post-category></span>&nbsp;<span class=post-category></span>&nbsp;<span class=post-category></span>&nbsp;<span class=post-series></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime=2022-05-08>2022-05-08</time>&nbsp;<i class="far fa-edit fa-fw"></i>&nbsp;<time datetime=2022-05-08>2022-05-08</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;&nbsp;
<i class="far fa-clock fa-fw"></i>&nbsp;&nbsp;</div></div><div class="details series-nav open"><div class="details-summary series-title"><span>- 自己动手用 C++ 实现一个容器运行时</span>
<span><i class="details-icon fas fa-angle-right"></i></span></div><div class="details-content series-content"><nav><ul><li><span class=active>开篇</span></li></ul></nav></div></div><div class="details toc" id=toc-static kept><div class="details-summary toc-title"><span></span>
<span><i class="details-icon fas fa-angle-right"></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#简介>简介</a></li><li><a href=#为什么是-c>为什么是 C++</a></li><li><a href=#完成本系列能够收获什么>完成本系列能够收获什么</a></li><li><a href=#预备知识>预备知识</a></li><li><a href=#我的开发环境>我的开发环境</a></li><li><a href=#搭建项目架构>搭建项目架构</a></li></ul></nav></div></div><div class=content id=content><p>本篇文章将开启一个新的系列：<strong>自己动手用 C++ 实现一个容器运行时</strong>。</p><h2 id=简介 class=headerLink><a href=#%e7%ae%80%e4%bb%8b class=header-mark></a>简介</h2><p>所谓容器运行时，就是负责如何创建、启动、停止、删除容器的程序。如果熟悉容器相关的知识，你可能会立即想到容器运行时的标准 Go 实现 runC<sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup>。没错，本系列的目标就是实现一个 C++ 版本的 runC。本系列的所有代码在这个 GitHub 仓库中保存<sup id=fnref:2><a href=#fn:2 class=footnote-ref role=doc-noteref>2</a></sup>。</p><h2 id=为什么是-c class=headerLink><a href=#%e4%b8%ba%e4%bb%80%e4%b9%88%e6%98%af-c class=header-mark></a>为什么是 C++</h2><p>Go 语言在云原生领域大行其道的今天，为什么选择 C++ 而不是 Go？选择 C++ 的原因主要有：</p><ul><li>选择一条别人从未走过的路。已经有一本书叫做《自己动手写 Docker》<sup id=fnref:3><a href=#fn:3 class=footnote-ref role=doc-noteref>3</a></sup>，书中用 Go 实现了一个简单的 Docker。</li><li>容器运行时涉及到大量系统底层的技术，例如 Linux namespaces、Linux cgroups、seccomp 等等，而在底层编程中 C/C++ 更有优势。</li><li>提升自己的 C++ 编码能力和大型项目能力。这个项目可能称不上「大型」，但算是一个良好的开端。</li></ul><h2 id=完成本系列能够收获什么 class=headerLink><a href=#%e5%ae%8c%e6%88%90%e6%9c%ac%e7%b3%bb%e5%88%97%e8%83%bd%e5%a4%9f%e6%94%b6%e8%8e%b7%e4%bb%80%e4%b9%88 class=header-mark></a>完成本系列能够收获什么</h2><p>本系列的重点有两个：<strong>容器运行时的实现原理</strong>和 <strong>C++ 编码能力</strong>。完成本系列能够收获的技能点：</p><ul><li>提升 C++ 编码能力。</li><li>如何用 CMake 管理并构建一个 C++ 项目。</li><li>阅读分析 runC 的源码。</li><li>掌握容器运行时的实现原理。</li><li>掌握 Linux 内核中与容器实现相关的特性，例如 namespaces、cgroups、seccomp、capabilities。</li></ul><h2 id=预备知识 class=headerLink><a href=#%e9%a2%84%e5%a4%87%e7%9f%a5%e8%af%86 class=header-mark></a>预备知识</h2><p>要开始本系列，首先要有 C++ 基础编码能力，但不包括 OOP（Oriented Object Programming），因为我也不会 😅。</p><p>其次需要了解 CMake 的基础用法。本系列不会过多讲解 CMake 基础用法，但是会讨论如何更优雅地使用 CMake。毕竟这也属于「管理并构建一个 C++ 项目」的范畴。</p><p>了解 Linux 系统编程。这个不是必须，但建议同步学习《UNIX 环境高级编程》<sup id=fnref:4><a href=#fn:4 class=footnote-ref role=doc-noteref>4</a></sup>或者《Linux/UNIX 系统编程手册》<sup id=fnref:5><a href=#fn:5 class=footnote-ref role=doc-noteref>5</a></sup>。</p><h2 id=我的开发环境 class=headerLink><a href=#%e6%88%91%e7%9a%84%e5%bc%80%e5%8f%91%e7%8e%af%e5%a2%83 class=header-mark></a>我的开发环境</h2><p>操作系统：macOS 和 Arch Linux。</p><p>编辑器：Neovim。</p><h2 id=搭建项目架构 class=headerLink><a href=#%e6%90%ad%e5%bb%ba%e9%a1%b9%e7%9b%ae%e6%9e%b6%e6%9e%84 class=header-mark></a>搭建项目架构</h2><p>整体的项目目录结构为：</p><pre tabindex=0><code>.
├── .clang-format
├── CMakeLists.txt
├── docs
├── .gitignore
├── README.md
├── src
│   ├── CMakeLists.txt
│   └── main.cc
└── tests
    └── CMakeLists.txt
</code></pre><ul><li><p><code>.clang-format</code> 是 <code>clang-format</code> 命令的配置文件。</p></li><li><p><code>docs</code> 目录用于保存文档。</p></li><li><p><code>src</code> 是源码目录。为了避免写很多 CMakeLists.txt，所有的源码放在同级目录中，不再新建子目录。</p></li><li><p><code>tests</code> 目录保存单元测试相关的源码。</p></li><li><p>代码格式化工具使用 <strong>clang-format</strong>。</p></li><li><p>单元测试框架使用 <strong>GoogleTest</strong>。</p></li><li><p>使用第三方库 <strong>CLI11</strong> 解析命令行参数。这个库的基本使用方法可以参考文章 <a href=https://nitroc.org/posts/cli11-tutorial/ rel>CLI11：命令行参数解析库</a> 。</p></li><li><p>使用 <strong>C++11</strong> 标准。后续可能考虑使用更新的标准。</p></li><li><p>动态调试工具使用 <strong>GDB</strong>。</p></li></ul><p>搭建项目结构的相关代码可以查看相关的 commits：aeaaad2<sup id=fnref:6><a href=#fn:6 class=footnote-ref role=doc-noteref>6</a></sup>、c434e1d<sup id=fnref:7><a href=#fn:7 class=footnote-ref role=doc-noteref>7</a></sup>、a006739<sup id=fnref:8><a href=#fn:8 class=footnote-ref role=doc-noteref>8</a></sup>。</p><div class=footnotes role=doc-endnotes><hr><ol><li id=fn:1><p><a href=https://github.com/opencontainers/runc target=_blank rel="noopener noreffer">https://github.com/opencontainers/runc</a>&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:2><p><a href=https://github.com/NitroCao/mydocker target=_blank rel="noopener noreffer">https://github.com/NitroCao/mydocker</a>&#160;<a href=#fnref:2 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:3><p><a href=https://book.douban.com/subject/27082348/ target=_blank rel="noopener noreffer">https://book.douban.com/subject/27082348/</a>&#160;<a href=#fnref:3 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:4><p><a href=https://book.douban.com/subject/25900403/ target=_blank rel="noopener noreffer">https://book.douban.com/subject/25900403/</a>&#160;<a href=#fnref:4 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:5><p><a href=https://book.douban.com/subject/25809330/ target=_blank rel="noopener noreffer">https://book.douban.com/subject/25809330/</a>&#160;<a href=#fnref:5 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:6><p><a href=https://github.com/NitroCao/mydocker/commit/aeaaad223b355cfdfdc45df2716bf35f4735d2fe target=_blank rel="noopener noreffer">https://github.com/NitroCao/mydocker/commit/aeaaad223b355cfdfdc45df2716bf35f4735d2fe</a>&#160;<a href=#fnref:6 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:7><p><a href=https://github.com/NitroCao/mydocker/commit/c434e1dee903e6753385cfb0c5ef222411a36dd7 target=_blank rel="noopener noreffer">https://github.com/NitroCao/mydocker/commit/c434e1dee903e6753385cfb0c5ef222411a36dd7</a>&#160;<a href=#fnref:7 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:8><p><a href=https://github.com/NitroCao/mydocker/commit/a0067392a3ad414336ed7e721c147f069b02fc06 target=_blank rel="noopener noreffer">https://github.com/NitroCao/mydocker/commit/a0067392a3ad414336ed7e721c147f069b02fc06</a>&#160;<a href=#fnref:8 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></div></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span></span></div><div class=post-info-license></div></div><div class=post-info-line><div class=post-info-md></div><div class=post-info-share><span></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fas fa-tags fa-fw"></i>&nbsp;<a href=/tags/linux/>Linux</a>,&nbsp;<a href=/tags/container/>Container</a>,&nbsp;<a href=/tags/cloud-native/>Cloud Native</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()></a></span>&nbsp;|&nbsp;<span><a href=/></a></span></section></div><div class=post-nav><a href=/posts/cli11-tutorial/ class=prev rel=prev title=CLI11：命令行参数解析库><i class="fas fa-angle-left fa-fw"></i>CLI11：命令行参数解析库</a></div></div><div id=comments><div id=gitalk class=comment></div><noscript>Please enable JavaScript to view the comments powered by <a href=https://github.com/gitalk/gitalk></a>Gitalk</a>.</noscript></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line>由 Hugo 强力驱动</div><div class=footer-line>&nbsp;|&nbsp;</div><div class=footer-line><i class="far fa-copyright fa-fw"></i><span itemprop=copyrightYear>2022</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=/ target=_blank rel="noopener noreferrer"></a></span>&nbsp;|&nbsp;<span class=license><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div><div class=footer-line></div><div class=footer-line></div></div></footer></div><div id=fixed-buttons><a href=#back-to-top id=back-to-top-button class=fixed-button title><i class="fas fa-arrow-up fa-fw"></i>
</a><a href=# id=view-comments class=fixed-button title><i class="fas fa-comment fa-fw"></i></a></div><div class=assets><script type=text/javascript src=/lib/lazysizes/lazysizes.min.js></script><script type=text/javascript src=/lib/topbar/topbar.min.js></script><script type=text/javascript src=/lib/pjax/pjax.min.js></script><script type=text/javascript src=/js/theme.min.js defer></script></div><div class=pjax-assets><script type=text/javascript>window.config={code:{copyTitle:"",maxShownLines:50},comment:{gitalk:{admin:["NitroCao"],clientID:"94646e9139c4cfbac497",clientSecret:"0fda151ceb53b61ce441679301c2e558c2ffb86b",id:"2022-05-08T11:12:05+08:00",owner:"NitroCao",repo:"nitrocao.github.io",title:"开篇"}}}</script><script type=text/javascript src=/lib/gitalk/gitalk.min.js></script><script type=text/javascript src=/js/gitalk.min.js defer></script><script type=text/javascript src=/lib/clipboard/clipboard.min.js></script><link rel=stylesheet href=/lib/gitalk/gitalk.min.css></div></body></html>